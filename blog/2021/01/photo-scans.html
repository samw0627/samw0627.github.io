<!DOCTYPE html>
<html lang="en-US">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="application-name" content="Sam Wong">
  <meta name="theme-color" content="#b00">
  <link rel="shortcut icon" href="/favicon.ico"/>
  <link rel="icon" type="image/png" href="/favicon.png" sizes="250x250" />

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Scanning Photo Albums | Sam Wong</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Scanning Photo Albums" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How we are scanning dozens of photo albums and process them with open source tools" />
<meta property="og:description" content="How we are scanning dozens of photo albums and process them with open source tools" />
<link rel="canonical" href="https://samw0627.github.io/blog/2021/01/photo-scans.html" />
<meta property="og:url" content="https://samw0627.github.io/blog/2021/01/photo-scans.html" />
<meta property="og:site_name" content="Sam Wong" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-28T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Scanning Photo Albums" />
<meta name="twitter:site" content="@domoritz" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-01-28T00:00:00+00:00","datePublished":"2021-01-28T00:00:00+00:00","description":"How we are scanning dozens of photo albums and process them with open source tools","headline":"Scanning Photo Albums","mainEntityOfPage":{"@type":"WebPage","@id":"https://samw0627.github.io/blog/2021/01/photo-scans.html"},"url":"https://samw0627.github.io/blog/2021/01/photo-scans.html"}</script>
<!-- End Jekyll SEO tag -->


  <link rel="alternate" type="application/rss+xml" title="Sam Wong" href="https://samw0627.github.io/feed.xml">

  <link href="https://use.fontawesome.com/releases/v6.7.2/css/all.css" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">
</head>

  <body>
    
<header class="page-header">
  <nav class="container">
    <a class="site-title" href="/">Sam Wong</a>

    <a href="/projects/" >Projects</a>
    <a href="/publications/" >Publications</a>
    <a href="/talks/" >Talks</a>
    <a href="/blog/" aria-current="page">Blog</a>
    <!-- <a href="/cv/" >CV</a> -->
    <a href="https://docs.google.com/document/d/1-isyXIbIYdkAbXpjAtFqDBIJGTswV75oZ_GFzHkoXr8/edit?usp=sharing" target="_blank" rel="noopener">CV</a>

    <span class="external">
      <a href="https://bsky.app/profile/domoritz.de"><i class="fa-brands fa-bluesky" aria-hidden="true"></i> Bsky</a>
      <a href="mailto:domoritz@cmu.edu"><i class="fa-solid fa-envelope" aria-hidden="true"></i> Email</a>
    </span>
  </nav>
</header>


    <main class="page-content">
      <article class="container post">
  <header class="post-header">
    <h1 class="post-title">Scanning Photo Albums</h1>
    <p class="post-subtitle">How we are scanning dozens of photo albums and process them with open source tools</p>
    <p class="post-meta">
      Published on Jan 28, 2021
      
      
      </p>
  </header>

  <div class="post-content">
    <p>As a millennial, most of my childhood is not recorded in digital photos but in videos on VHS tapes and photos albums that my parents have. I like flipping through digital photos and so I decided that it’s time to get all the pictures into digital form. Now the question is how? In this post I am showing that a simple flatbed scanner and some open source command line tools (Fred’s ImageMagick Scripts, ImageMagick/GraphicsMagick, Parallel, Exiftool, and standard UNIX tools) are fast and produce good quality images.</p>

<h2 id="photo-scanner-apps-are-not-good-enough">Photo scanner apps are not good enough</h2>

<p>My first idea was to use the good camera on my phone. I have seen apps such as <a href="https://www.google.com/photos/scan/">Google Photo Scan</a> that promise to avoid glare and other artifacts that you get if you just took a photo. I tried a few apps but none of them  worked. It takes forever to scan a single photo, there are artifacts on the images, and since pictures are not flat, the scans often come out distorted.</p>

<h2 id="scanning-and-segmenting-images-with-image-capture-almost-worked">Scanning and segmenting images with Image Capture almost worked</h2>

<p>My next idea was to use the flatbed scanner we already have in our multifunction printer. The scans are actually really good. The problem is that I don’t want to crop all images by hand. I have a mac and the <em>Image Capture</em> app (which already comes with macOS) has a decent cropping function. However, it uses the scanner preview (scanners typically show you a quick preview, then you decide which region to scan, and then they scan the selected region). The preview often isn’t good enough to properly segment the image so I decided to build my own segmentation pipeline with some open source tools.</p>

<h2 id="a-pipeline-for-scanning-and-segmenting-dozens-of-photo-albums">A pipeline for scanning and segmenting dozens of photo albums</h2>

<p>The following pipeline worked well for us. In short, we scan full pages, crop them with <code class="language-plaintext highlighter-rouge">multicrop</code>, then convert them to JPEG, and set the correct dates.</p>

<p>First, we put as many pictures on the flatbed scanner as we can fit. Ideally, they are ordered from top-right, over to the left, to the bottom left when you put them on the scanner. This way they are in the correct order in the scanned image. Now, we scan the full page in 600 DPI (that’s my scanner’s max and it worked well) as TIFF. Scanning the full page means we don’t need a preview and can go through a photo album in half an hour.</p>

<p>Now we have a folder full of scans such as this one scan.</p>

<picture>
<img src="/images/scan.jpg" width="300" alt="Four family pictures scanned in a single image" />
</picture>

<p>Note that all scans have the name <code class="language-plaintext highlighter-rouge">Combi_{}.tiff</code>. The rest of my scripts assume this name and so if you follow this post, make sure to set the right name in Image Capture.</p>

<p>The next step is to segment the images. <a href="http://www.fmwconcepts.com/imagemagick/multicrop/index.php">Fred’s ImageMagick Scripts</a> are really good for this task. I downloaded and installed (copied into my path and made them executable) the <code class="language-plaintext highlighter-rouge">multicrop</code>, <code class="language-plaintext highlighter-rouge">unrotate</code>, and <code class="language-plaintext highlighter-rouge">autotrim</code> scripts. To avoid problems with spaces, I first replace all spaces with <code class="language-plaintext highlighter-rouge">_</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find <span class="nb">.</span> <span class="nt">-type</span> f <span class="nt">-name</span> <span class="s2">"*.tiff"</span> <span class="nt">-exec</span> rename <span class="s2">"s/</span><span class="se">\s</span><span class="s2">/_/g"</span> <span class="o">{}</span> <span class="se">\;</span>
</code></pre></div></div>

<p>Then I crop images with Multicrop, which is documented <a href="http://www.fmwconcepts.com/imagemagick/multicrop/index.php">here</a>. I don’t want to process the images one by one so I use <a href="https://www.gnu.org/software/parallel/">GNU parallel</a> to run 6 processes at the same time (might be different for you).</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find <span class="nb">.</span> <span class="nt">-name</span> <span class="s2">"*.tiff"</span> | parallel <span class="nt">-j</span> 6 <span class="nt">--eta</span> <span class="nt">-q</span> multicrop <span class="nt">-c</span> 50,50 <span class="nt">-u</span> 2 <span class="nt">-m</span> save <span class="nt">-i</span> <span class="nb">yes</span> <span class="o">{}</span> <span class="o">{</span>/.<span class="o">}</span>_split.tiff
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">-c 50,50</code> says where to find the background color for segmentation. 50 pixels off the top right corner worked well for me. <code class="language-plaintext highlighter-rouge">-u 2</code> uses a slightly better (but slower) algorithm to detect rotations. <code class="language-plaintext highlighter-rouge">-m save</code> saves the mask (for debugging purposes). <code class="language-plaintext highlighter-rouge">-i yes</code> trims the segmented images a bit so that we don’t get a white border.</p>

<p>Multicrop runs some algorithms to find a mask such as this one.</p>

<picture>
<img src="/images/mask.png" width="200" alt="Red rectangles corresponding to the four images" />
</picture>

<p>Don’t worry if the masks are not perfect. Multicrop then uses the mask to find the images to segment and outputs segmented images such as these four.</p>

<picture>
<img src="/images/split.png" width="700" alt="Four images in finder" />
</picture>

<p>Multicrop takes a while to process images so you can grab a beverage of your choice while your computer is hard at work (such as mine was as you can see below).</p>

<picture>
<img src="/images/cpu.png" width="300" alt="CPU usage chart showing high CPU usage" />
</picture>

<h2 id="fixing-orientation-and-converting-to-jpeg">Fixing orientation and converting to JPEG</h2>

<p>Now we have nicely segmented images but they are often incorrectly rotated, are still TIFFs, and they have the wrong dates. I corrected the orientation manually in Finder.</p>

<p>Rotating images with Finder doesn’t always reliably rotate the images after processing so I had to apply the orientation change to the images. To do this and to then convert all images to JPEGs, I used <a href="http://www.graphicsmagick.org">GraphicsMagick</a> (ImageMagick also works).</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gm mogrify <span class="nt">-auto-orient</span> <span class="k">*</span>_split-<span class="k">*</span>.tiff
gm mogrify <span class="nt">-format</span> jpg <span class="nt">-quality</span> 90% <span class="k">*</span>_split-<span class="k">*</span>.tiff
</code></pre></div></div>

<h2 id="correcting-dates">Correcting dates</h2>

<p>Next, I wanted to have correct dates in the images. However, I also wanted the images to have the correct order when I look at them in e.g. Apple Photos. My idea was to set the dates of the image to the correct date and to use the time to sort them correctly. To set the right time, I set it based on the file names (which are in the correct order).</p>

<p>But first I made a folder for each set of images that I wanted to have the same date.</p>

<p>My files are <code class="language-plaintext highlighter-rouge">Combi_{i}_split-{sss}.{tiff,jpg}</code> where <code class="language-plaintext highlighter-rouge">i</code> is a sequence number (e.g. 0, 12, or 32) and <code class="language-plaintext highlighter-rouge">sss</code> is a three digit number that identifies an image inside a scan. I set the minutes to <code class="language-plaintext highlighter-rouge">i</code> (by adding a leading 0 if needed and subtracting a start value so I don’t go over 59) and seconds to <code class="language-plaintext highlighter-rouge">s</code>. I assume that there are at most 8 images per scan and that there are at most 59 scans. Since I put all scans that should have the same date into one folder, this limitation hasn’t been a problem.</p>

<p>I created the following bash script, which I called <code class="language-plaintext highlighter-rouge">setdatetimeoriginal</code> and put it in my path. It uses <a href="https://exiftool.org">Exiftool</a> to set the <code class="language-plaintext highlighter-rouge">DateTimeOriginal</code> EXIF property as described above.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="nv">start</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">end</span><span class="o">=</span><span class="nv">$2</span>
<span class="nb">date</span><span class="o">=</span><span class="nv">$3</span>

<span class="k">for </span>m <span class="k">in</span> <span class="si">$(</span><span class="nb">seq</span> <span class="nv">$start</span> <span class="nv">$end</span><span class="si">)</span>
<span class="k">do
    </span><span class="nb">echo</span> <span class="s2">"Setting dates for Combi_</span><span class="k">${</span><span class="nv">m</span><span class="k">}</span><span class="s2">_split-00*.*"</span>
    <span class="nv">minutes</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s2">"%02d"</span> <span class="k">$((</span><span class="nv">$m</span><span class="o">-</span><span class="nv">$start</span><span class="k">))</span><span class="si">)</span>
    <span class="k">for </span>s <span class="k">in</span> <span class="si">$(</span><span class="nb">seq </span>0 8<span class="si">)</span>
    <span class="k">do
        </span><span class="nv">file</span><span class="o">=</span>Combi_<span class="k">${</span><span class="nv">m</span><span class="k">}</span>_split-00<span class="k">${</span><span class="nv">s</span><span class="k">}</span>
        <span class="k">if </span><span class="nb">test</span> <span class="nt">-f</span> <span class="s2">"</span><span class="k">${</span><span class="nv">file</span><span class="k">}</span><span class="s2">.tiff"</span><span class="p">;</span> <span class="k">then
            </span>exiftool <span class="s1">'-datetimeoriginal='</span><span class="s2">"</span><span class="k">${</span><span class="nv">date</span><span class="k">}</span><span class="s2">"</span><span class="s1">' 12:'</span><span class="s2">"</span><span class="k">${</span><span class="nv">minutes</span><span class="k">}</span><span class="s2">"</span><span class="s1">':'</span>0<span class="s2">"</span><span class="k">${</span><span class="nv">s</span><span class="k">}</span><span class="s2">"</span><span class="s1">''</span> <span class="nt">-overwrite_original</span> <span class="k">${</span><span class="nv">file</span><span class="k">}*</span>
        <span class="k">fi
    done
done</span>
</code></pre></div></div>

<p>Now, I can run <code class="language-plaintext highlighter-rouge">setdatetimeoriginal 27 32 1990:10:15</code> to set the dates and order (by time) of all images in a folder. The output of the script looks something like this.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Setting dates for Combi_27_split-00*.*
    2 image files updated
    2 image files updated
    2 image files updated
    2 image files updated
Setting dates for Combi_28_split-00*.*
    2 image files updated
    2 image files updated
</code></pre></div></div>

<p>That’s it. I am really happy with the results. I was especially impressed with the quality of the segmentations and hope that you find this post useful if you want to scan your family photos.</p>

  </div>

  <div class="blog-links">
  
    <div>
      <i class="fas fa-md fa-chevron-left"></i>
      <a href="/blog/2018/10/draco-representing-applying-learning-vis-design.html" title="Previous Post: Draco: Representing, Applying & Learning Visualization Design">Draco: Representing, Applying & Learning Visualization Design</a>
    </div>
  
  
    <div>
      <a href="/phd-application/" title="Next Post: ">Applying for a PhD</a>
      <i class="fas fa-md fa-chevron-right"></i>
    </div>
  
  </div>
</article>

    </main>

    <footer>
  <div class="container">
    <div class="footer-col">
      Hello from Seattle.<br/>
      <abbr title="Last build on 2025-03-10">March 2025</abbr>
    </div>
    <div class="footer-col">
      This template is based on <a href="https://github.com/domoritz/domoritz.github.io">Dominik Moritz's website</a>.
    </div>
    <div class="footer-col site-desc">HCI researcher at Social Futures Lab, Paul.G. Allen School of Computer Science & Engineering, University of Washington.
</div>
  </div>
</footer>

    <script>
  function trim(str) {
    return str.replace(/^\s+|\s+$/g, '');
  }
  var headers = document.querySelectorAll("h2, h3, h4, h5, h6");
  for (var i=0; i<headers.length; i++) {
    var h = headers[i];
    var name = h.getAttribute("id");
    var title = h.innerHTML;
    h.innerHTML = '<a href="#' + name + '" class="anchor"><i class="fas fa-hashtag"></i></a>' + trim(title);
  }
</script>

  </body>
</html>
